{% extends "_base.html" %}
{% block title %}–û–ß –¥–ª—è {{ bank }}{% endblock %}
{% block content %}
<style>
    .calc-card {
        background: rgba(20, 20, 20, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        padding: 2rem;
    }
    .result-main {
        background: rgba(13, 110, 253, 0.1);
        border: 1px dashed rgba(13, 110, 253, 0.5);
        border-radius: 15px;
    }
    .total-highlight {
        font-size: 2.5rem;
        font-weight: 900;
        color: #fff;
        border-radius: 12px;
        padding: 10px 20px;
        display: inline-block;
        width: 100%;
        text-shadow: none;
        -webkit-background-clip: initial;
        -webkit-text-fill-color: initial;
    }
</style>

<div class="container mt-5" id="capture-area">
    <div class="row justify-content-center">
        <div class="col-lg-7">
            <div class="calc-card shadow-2xl text-white">
                
                <div class="d-flex justify-content-between mb-4 border-bottom border-secondary pb-3">
                    <div>
                        <h2 class="fw-bold mb-0">–ú–∏—Ç—Ç—î–≤–∞ —Ä–æ–∑—Å—Ç—Ä–æ—á–∫–∞</h2>
                        <div id="live-time" class="small text-muted mt-1"></div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm align-self-start" data-bs-toggle="modal" data-bs-target="#ratesModal">
                        <i class="bi bi-sliders"></i> –°—Ç–∞–≤–∫–∏
                    </button>
                </div>

                <div class="mb-4 text-center">
                    <div class="btn-group w-100 shadow-sm">
                        {% for bank in rates_json.keys() %}
                        <button class="btn btn-outline-primary bank-btn py-3 fw-bold" onclick="selectBank('{{ bank }}')">
                            {{ bank }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small">–°—É–º–∞ —Ç–æ–≤–∞—Ä—É</label>
                        <div class="input-group input-group-lg">
                            <input type="number" id="total-amount" class="form-control bg-dark text-white border-secondary fw-bold" value="35000" oninput="calculate()">
                            <span class="input-group-text bg-dark text-white-50 border-secondary">‚Ç¥</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-white-50 small">–¢–µ—Ä–º—ñ–Ω —Ä–æ–∑—Å—Ç—Ä–æ—á–∫–∏</label>
                        <select id="months-select" class="form-select form-select-lg bg-dark text-white border-secondary" onchange="calculate()">
                            </select>
                    </div>
                </div>

                <div class="result-main p-4 text-center mb-4">
                    <div class="row mb-3">
                        <div class="col-4">
                            <small class="text-white-50 d-block">–©–æ–º—ñ—Å—è—á–Ω–æ</small>
                            <h4 id="monthly-payment" class="fw-bold mb-0 text-info">0 ‚Ç¥</h4>
                        </div>
                        <div class="col-4 border-start border-end border-secondary border-opacity-50">
                            <small class="text-white-50 d-block">–ü–µ—Ä–µ–ø–ª–∞—Ç–∞</small>
                            <h4 id="overpayment" class="fw-bold mb-0 text-warning">0 ‚Ç¥</h4>
                        </div>
                        <div class="col-4">
                            <small class="text-white-50 d-block">–°—Ç–∞–≤–∫–∞</small>
                            <h4 id="current-rate-display" class="fw-bold mb-0">0%</h4>
                        </div>
                    </div>
                    
                    <div class="pt-3 border-top border-secondary border-opacity-25">
                        <small class="text-white-50">–§–Ü–ù–ê–õ–¨–ù–ê –°–£–ú–ê –î–û –°–ü–õ–ê–¢–ò</small>
                        <div id="final-total" class="total-highlight fw-black">0 ‚Ç¥</div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-warning btn-lg fw-bold py-3 shadow" onclick="copyCalculator()">
                        <i class="bi bi-camera-fill me-2"></i> –°–∫–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ratesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <div class="modal-content bg-dark text-white border-secondary">
            <form action="{{ url_for('update_rates') }}" method="POST">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class=" me-2 text-warning"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∫–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –û–ß</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <p class="small text-muted mb-4"></p>
                    
                    {% for bank, months_data in rates_json.items() %}
                    <div class="mb-4">
                        <h6 class="text-primary fw-bold border-bottom border-secondary pb-2">{{ bank }}</h6>
                        <div class="row g-2">
                            {% for month, rate in months_data.items() | sort(attribute='0') %}
                            <div class="col-md-4 col-6 mb-2">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-secondary text-white border-secondary" style="min-width: 65px;">
                                        {{ month }} –º—ñ—Å.
                                    </span>
                                    <input type="number" step="0.01" 
                                           name="{{ bank }}_{{ month }}" 
                                           value="{{ rate }}" 
                                           class="form-control bg-dark text-white border-secondary text-center">
                                    <span class="input-group-text bg-dark text-muted border-secondary">%</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                    <button type="submit" class="btn btn-warning fw-bold px-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const allRates = {{ rates_json | tojson | safe }};
let selectedBank = Object.keys(allRates)[0];

function selectBank(name) {
    if (!allRates[name]) return;
    selectedBank = name;
    const select = document.getElementById('months-select');
    select.innerHTML = '';
    
    const availableMonths = Object.keys(allRates[name])
        .map(Number)
        .filter(m => m >= 3 && m <= 12)
        .sort((a, b) => a - b);

    availableMonths.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.innerText = m + " –º—ñ—Å—è—Ü—ñ–≤";
        select.appendChild(opt);
    });

    document.querySelectorAll('.bank-btn').forEach(b => {
        const isSelected = b.innerText.trim() === name;
        b.classList.toggle('active', isSelected);
        b.classList.toggle('btn-primary', isSelected);
    });
    calculate();
}

function calculate() {
    const amountInput = document.getElementById('total-amount');
    const monthsSelect = document.getElementById('months-select');
    const amount = parseFloat(amountInput.value) || 0;
    const months = monthsSelect.value;
    
    const rate = (allRates[selectedBank] && allRates[selectedBank][months]) 
                 ? allRates[selectedBank][months] 
                 : 0;

    const overpayment = (amount * (rate / 100)) * parseInt(months);
    const total = amount + overpayment;
    const monthly = total / parseInt(months);

    document.getElementById('current-rate-display').innerText = rate + "%";
    document.getElementById('monthly-payment').innerText = Math.round(monthly).toLocaleString('uk-UA') + " ‚Ç¥";
    document.getElementById('overpayment').innerText = Math.round(overpayment).toLocaleString('uk-UA') + " ‚Ç¥";
    document.getElementById('final-total').innerText = Math.round(total).toLocaleString('uk-UA') + " ‚Ç¥";
}


async function copyCalculator() {
    const area = document.getElementById('capture-area');
    

    const btn = document.querySelector('button[onclick="copyCalculator()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –°—Ç–≤–æ—Ä—é—é —Ñ–æ—Ç–æ...';

    try {
        const canvas = await html2canvas(area, {
            backgroundColor: '#121212', 
            scale: 2,                  
            useCORS: true
        });

        canvas.toBlob(async (blob) => {
            try {
                const item = new ClipboardItem({ "image/png": blob });
                await navigator.clipboard.write([item]);
                alert("‚úÖ –§–æ—Ç–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤ –±—É—Ñ–µ—Ä—ñ! –ù–∞—Ç–∏—Å–∫–∞–π Ctrl+V —É Telegram.");
            } catch (err) {
                
                const imgURL = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = imgURL;
                link.download = `calc_${selectedBank}.png`;
                link.click();
                alert("üìé –ë—Ä–∞—É–∑–µ—Ä –æ–±–º–µ–∂–∏–≤ –ø—Ä—è–º–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è. –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –Ω–∞ –∫–æ–º–ø'—é—Ç–µ—Ä!");
            }
        });
    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —Å–∫—Ä—ñ–Ω—à–æ—Ç—É:", error);
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–æ—Ç–æ.");
    } finally {
        btn.innerHTML = originalText;
    }
}


function updateTime() {
    const now = new Date();
    const timeStr = now.toLocaleString('uk-UA', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
    });
    const timeElem = document.getElementById('live-time');
    if (timeElem) timeElem.innerText = timeStr;
}

document.addEventListener('DOMContentLoaded', () => {
    if (selectedBank) selectBank(selectedBank);
    updateTime();
    setInterval(updateTime, 1000);
});
</script>
{% endblock %}