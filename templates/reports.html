{% extends "_base.html" %}

{% block title %}–†–æ–∑—à–∏—Ä–µ–Ω—ñ –ó–≤—ñ—Ç–∏{% endblock %}

{% block content %}
<h1 class="mb-4">üìà –†–æ–∑—à–∏—Ä–µ–Ω—ñ –ó–≤—ñ—Ç–∏ WIP</h1>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">–§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –ø–µ—Ä—ñ–æ–¥–æ–º</h5>
        <form method="GET" action="{{ url_for('advanced_reports') }}" class="row g-3 align-items-end">
            
            <div class="col-md-4">
                <label for="startDate" class="form-label">–ü–æ—á–∞—Ç–∫–æ–≤–∞ –¥–∞—Ç–∞ (–ó)</label>
                <input type="date" class="form-control" id="startDate" name="start_date" value="{{ start_date or '' }}">
            </div>
            
            <div class="col-md-4">
                <label for="endDate" class="form-label">–ö—ñ–Ω—Ü–µ–≤–∞ –¥–∞—Ç–∞ (–ü–æ)</label>
                <input type="date" class="form-control" id="endDate" name="end_date" value="{{ end_date or '' }}">
            </div>
            
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel"></i> –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä
                </button>
            </div>
        </form>
    </div>
</div>

<h2 class="mt-5 mb-3">–°–≤–æ–¥–∫–∞ –∑–∞ –ø–µ—Ä—ñ–æ–¥ 
    {% if start_date and end_date %}({{ start_date }} ‚Äì {{ end_date }}){% endif %}
</h2>
<div class="row mb-5">
    {% set total_period = 0 %}
    {% for stat in status_stats %}
        {% set total_period = total_period + stat.count %}
    {% endfor %}

    <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-0 h-100 bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">–í—Å—å–æ–≥–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ</h5>
                <p class="card-text fs-1 fw-bold">{{ total_period }}</p>
            </div>
        </div>
    </div>

    {% for stat in status_stats %}
        {% set bg_class = 'bg-success' if stat.status == '–ò—Å–ø–æ–ª–Ω–µ–Ω–æ' 
                         else ('bg-danger' if stat.status == '–û—Ç–∫–∞–∑' 
                         else ('bg-warning text-dark' if stat.status == '–í —Ä–∞–±–æ—Ç–µ' 
                         else ('bg-info text-dark' if stat.status == '–ü—Ä–∏–Ω—è—Ç'
                         else 'bg-secondary'))) %}
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm border-0 h-100 {{ bg_class }}">
                <div class="card-body">
                    <h5 class="card-title">{{ stat.status }}</h5>
                    <p class="card-text fs-1 fw-bold">{{ stat.count }}</p>
                    <small>({{ "%.1f" | format(stat.count * 100 / total_period if total_period > 0 else 0) }}%)</small>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<h2 class="mt-5 mb-3">–î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>–î–∞—Ç–∞</th>
                <th>–ö–ª—ñ—î–Ω—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody>
            {% for record in detailed_records %}
            <tr onclick="window.location='{{ url_for('view_record', record_id=record.id) }}';" style="cursor: pointer;">
                <td>{{ record.id }}</td>
                <td>{{ record.request_date }}</td>
                <td>{{ record.client_name }}</td>
                <td><span class="badge 
                    {% if record.status == '–ò—Å–ø–æ–ª–Ω–µ–Ω–æ' %}bg-success
                    {% elif record.status == '–í —Ä–∞–±–æ—Ç–µ' %}bg-warning text-dark
                    {% elif record.status == '–ü—Ä–∏–Ω—è—Ç' %}bg-primary
                    {% else %}bg-secondary
                    {% endif %}">{{ record.status }}</span>
                </td>
                <td><a href="{{ url_for('view_record', record_id=record.id) }}" class="btn btn-sm btn-outline-info">
                    <i class="bi bi-eye"></i> –ü–µ—Ä–µ–≥–ª—è–¥
                </a></td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center text-muted">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Ñ—ñ–ª—å—Ç—Ä—É.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}